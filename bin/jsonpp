#!/usr/bin/env ruby
require 'multi_json'

PAIRS = {
  :load => [:load, :dump],
  :decode => [:decode, :encode],
}

def main(file_path)
  case file_path
  when '-h', '--help'
    puts "Usage: jsonpp [file]"
    puts "Pretty-prints the given file or stdin"
  when '-', nil
    input = $stdin.read
  else
    input = File.read file_path
  end

  if MultiJson.respond_to?(:load)
    decode, encode = PAIRS[:load]
  else
    decode, encode = PAIRS[:decode]
  end

  data = MultiJson.public_send(decode, input)
  output = MultiJson.public_send(encode, data, :pretty => true)

  puts output
rescue MultiJson::DecodeError => ex
  $stderr.puts ex
  exit 1
end

main(ARGV[0])
